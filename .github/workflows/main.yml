name: CryptoFlash Main Workflow

on:
  # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 * * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
permissions:
    contents: write  # èµ‹äºˆå†™ä»“åº“å†…å®¹çš„æƒé™
jobs:
  run-cryptoflash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run CryptoFlash
      env:
        # å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®ç¯å¢ƒå˜é‡
        LOG_LEVEL: INFO
        # é€šçŸ¥å™¨é…ç½®ç¯å¢ƒå˜é‡
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
        EMAIL_SMTP_USER: ${{ secrets.EMAIL_SMTP_USER }}
        EMAIL_SMTP_PASSWORD: ${{ secrets.EMAIL_SMTP_PASSWORD }}
        EMAIL_TO_EMAILS: ${{ secrets.EMAIL_TO_EMAILS }}
        # Barké€šçŸ¥é…ç½®ç¯å¢ƒå˜é‡
        BARK_API_URL: ${{ secrets.BARK_API_URL || 'https://api.day.app' }}
        BARK_DEVICE_KEY: ${{ secrets.BARK_DEVICE_KEY }}
        BARK_GROUP: ${{ secrets.BARK_GROUP || 'crypto_flash' }}
        POOL_MAX_WORKERS: 5
      run: |
        python main.py
    

    
    - name: Commit and push if changes
      env:
        BRANCH_NAME: ${{ github.event.repository.default_branch }}
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        echo "ğŸ”„ Syncing with remote (branch: $BRANCH_NAME)..."
        git fetch origin $BRANCH_NAME
        git stash --include-untracked || echo "Nothing to stash"
        
        git reset --hard origin/$BRANCH_NAME
        
        git stash pop || echo "Nothing to pop"
        
        git add -A
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "ğŸ“­ No changes to commit"
          exit 0
        fi
        
        echo "ğŸ“ Committing changes..."
        TIMESTAMP=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
        git commit -m "Auto update by GitHub Actions at $TIMESTAMP"
        
        echo "â¬†ï¸ Pushing changes with retry..."
        for i in {1..5}; do
          git pull --rebase origin $BRANCH_NAME && git push origin $BRANCH_NAME && {
            echo "âœ… Successfully pushed on attempt $i"
            exit 0
          }
          echo "âš ï¸ Attempt $i failed, waiting $((i*3)) seconds..."
          sleep $((i * 3))
        done
        
        echo "âŒ Failed to push after 5 attempts"
        exit 1